<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Set Up Profile – Quask</title>
  <link rel="stylesheet" href="style.css" />
  <style>
  
    .profile-form {
      background-color: #ffffff;
      padding: 2rem 3rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 450px;
      text-align: center;
    }
    .avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: #d9e7ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }
    .hidden {
      display: none;
    }
    .upload-label {
      cursor: pointer;
      display: inline-block;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #4e9af1;
    }
    #save-btn {
      margin-top: 1.5rem;
    }
    .small {
      font-size: 0.85rem;
      color: #555;
    }
  </style>
</head>
<body>
  <header>
    <h1>Almost There</h1>
    <p>Pick a username and optionally upload a profile picture.</p>
  </header>

  <main class="auth-container">
    <div class="profile-form">
      <div class="avatar-preview" id="avatar-preview">
        <span id="avatar-initial">?</span>
      </div>
      <div>
        <input type="file" id="avatar-input" accept="image/*" class="hidden" />
        <label for="avatar-input" class="upload-label">Upload profile picture (optional)</label>
      </div>
      <div>
        <label for="username">Username:</label><br/>
        <input type="text" id="username" placeholder="e.g. quibblesfan" required />
      </div>
      <div class="small">You can skip uploading a picture; a default icon will be used.</div>
      <button id="save-btn" type="button">Save Profile</button>
    </div>
  </main>

  <footer>
    <p>© 2025 Quask. All rights reserved.</p>
  </footer>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDOZwIJjuyuux6Z9OQ9x6LBvu3CuxMWfuE",
      authDomain: "quask-a9e1b.firebaseapp.com",
      projectId: "quask-a9e1b",
      storageBucket: "quask-a9e1b.firebasestorage.app",
      messagingSenderId: "726397658400",
      appId: "1:726397658400:web:cac926ec2cbffea890a345",
      measurementId: "G-RT218LJWLP"
    };    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const storage = firebase.storage();

    
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

    
      if (user.displayName && user.displayName.trim() !== "") {
        window.location.href = "dashboard.html";
        return;
      }

      
      const fallbackInitial = user.email ? user.email[0].toUpperCase() : "?";
      document.getElementById("avatar-initial").textContent = fallbackInitial;
    });


    const avatarInput = document.getElementById("avatar-input");
    const avatarPreview = document.getElementById("avatar-preview");
    const avatarInitial = document.getElementById("avatar-initial");

    avatarInput.addEventListener("change", () => {
      const file = avatarInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        avatarInitial.style.display = "none";
        avatarPreview.style.backgroundImage = `url(${e.target.result})`;
        avatarPreview.style.backgroundSize = "cover";
        avatarPreview.style.backgroundPosition = "center";
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("save-btn").addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return alert("Not signed in.");

      const username = document.getElementById("username").value.trim();
      if (!username) {
        alert("Please enter a username.");
        return;
      }
      
      if (username.length < 3 || username.length > 20) {
        alert("Username must be 3–20 characters.");
        return;
      }

      try {
        let photoURL = null;
        const file = avatarInput.files[0];
        if (file) {
          const storageRef = storage.ref(`avatars/${user.uid}`);
          await storageRef.put(file);
          photoURL = await storageRef.getDownloadURL();
        }

        await user.updateProfile({
          displayName: username,
          ...(photoURL ? { photoURL } : {})
        });

        window.location.href = "dashboard.html";
      } catch (err) {
        console.error(err);
        alert("Failed to save profile: " + err.message);
      }
    });
  </script>

  
</body>
</html>
